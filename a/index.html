<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Interval Rest Timer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load a robust version of Tone.js for complex effects (r14) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Custom styles to ensure a clean, full-screen look and hide focus ring on time display */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        .timer-display {
            font-variant-numeric: tabular-nums; /* Keeps digits from shifting width */
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }
        .timer-display:focus {
            outline: none; /* Remove outline on the time display */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Card -->
    <div class="w-full max-w-md bg-gray-800 rounded-3xl shadow-2xl p-6 md:p-10 border border-green-700/50">
        <h1 class="3xl font-extrabold text-green-400 text-center mb-6 uppercase tracking-wider">
            Rest Interval Timer
        </h1>

        <!-- Timer Display -->
        <div id="timer-display" class="timer-display text-8xl md:text-9xl font-mono font-bold text-green-400 text-center py-10 tracking-tighter transition-colors duration-200"
             role="timer" aria-live="polite">
            01:00
        </div>

        <!-- Adjust Controls -->
        <div class="flex justify-center items-center space-x-4 mb-8">
            <button id="adjust-down" class="p-3 text-xl font-bold bg-red-600 hover:bg-red-700 text-white rounded-full transition duration-150 shadow-md disabled:opacity-50" disabled aria-label="Decrease time by 15 seconds">
                -15s
            </button>
            <span id="set-time-display" class="text-lg font-semibold text-gray-300">Set: 60s</span>
            <button id="adjust-up" class="p-3 text-xl font-bold bg-green-600 hover:bg-green-700 text-white rounded-full transition duration-150 shadow-md" aria-label="Increase time by 15 seconds">
                +15s
            </button>
        </div>

        <!-- Action Button -->
        <div class="text-center">
            <button id="main-action-button" class="w-full py-4 text-2xl font-extrabold text-gray-900 bg-green-400 hover:bg-green-300 rounded-xl transition duration-300 shadow-lg shadow-green-500/50 uppercase transform hover:scale-[1.01] active:scale-[0.99]" aria-controls="timer-display">
                Start Rest (1:00)
            </button>
        </div>

        <!-- Message/Status Area -->
        <div id="status-message" class="mt-6 text-center text-sm font-medium h-6 text-gray-400">
            Ready to lift!
        </div>

        <!-- Configuration State Display (Hidden utility for debugging) -->
        <div id="config-data" class="hidden" data-set-time="60"></div>
    </div>

    <script>
        const configData = document.getElementById('config-data');
        const timerDisplay = document.getElementById('timer-display');
        const setTimeDisplay = document.getElementById('set-time-display');
        const mainActionButton = document.getElementById('main-action-button');
        const adjustUpButton = document.getElementById('adjust-up');
        const adjustDownButton = document.getElementById('adjust-down');
        const statusMessage = document.getElementById('status-message');

        // Initial State
        const INITIAL_DEFAULT_TIME = 60; // seconds (1 minute)
        const INCREMENT = 15; // seconds
        let currentSetTime = INITIAL_DEFAULT_TIME;
        let currentTimeLeft = INITIAL_DEFAULT_TIME;
        let timerInterval = null;
        let isRunning = false;
        
        // --- Sound Setup (Tone.js) ---
        // Start by setting the final output to the speaker (Tone.Destination is an object)
        let outputNode = Tone.Destination; 

        try {
            // Attempt to initialize Tone effects: Fuzz for grit, Filter for piercing high pitch
            const fuzzNode = new Tone.Fuzz(3.0).toDestination(); 
            const filterNode = new Tone.Filter(2000, "highpass").connect(fuzzNode);
            
            // If initialization succeeded, the synth should connect to the filterNode
            outputNode = filterNode;
            console.log("Tone.js effects initialized successfully.");
        } catch(e) {
            console.warn("Tone.js effects (Fuzz/Filter) failed to initialize. Falling back to direct output.", e);
            // If they fail, outputNode remains Tone.Destination
        }
        
        // 3. MonoSynth for the base tone, connected to the determined output node
        const synth = new Tone.MonoSynth({
            oscillator: { type: 'sawtooth' }, // Sharp, brassy sound waveform
            envelope: {
                attack: 0.01,
                decay: 0.1, 
                sustain: 0.0,
                release: 0.2,
                amplitude: 1.0 // Max amplitude
            },
            filterEnvelope: { 
                attack: 0.01,
                decay: 0.05,
                sustain: 0.5,
                release: 0.2,
                baseFrequency: 400,
                octaves: 3,
                exponent: 1
            }
        }).connect(outputNode);
        
        // Helper to format time (seconds to MM:SS)
        const formatTime = (totalSeconds) => {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        // Function to update the UI based on current state
        const updateUI = () => {
            timerDisplay.textContent = formatTime(currentTimeLeft);
            setTimeDisplay.textContent = `Set: ${currentSetTime}s`;
            mainActionButton.textContent = isRunning ? 'Stop Rest' : `Start Rest (${formatTime(currentSetTime)})`;
            configData.dataset.setTime = currentSetTime;
            
            // Manage button disabling (cannot go below 15s)
            adjustDownButton.disabled = isRunning || currentSetTime <= INCREMENT;
            adjustUpButton.disabled = isRunning; 

            // Update button color/style based on running state
            if (isRunning) {
                mainActionButton.classList.remove('bg-green-400', 'shadow-green-500/50');
                mainActionButton.classList.add('bg-yellow-400', 'shadow-yellow-500/50');
                timerDisplay.classList.remove('text-green-400', 'text-red-400');
                timerDisplay.classList.add('text-yellow-400');
            } else {
                mainActionButton.classList.remove('bg-yellow-400', 'shadow-yellow-500/50');
                mainActionButton.classList.add('bg-green-400', 'shadow-green-500/50');
                // Change color if reset to default (green) or if time is 0 (red)
                timerDisplay.classList.remove('text-yellow-400', 'text-red-400');
                timerDisplay.classList.add(currentTimeLeft === 0 ? 'text-red-400' : 'text-green-400');
            }
        };

        // Function to play the loud expressive horn blast
        const playAlarm = () => {
            try {
                // Dual-note blast for urgency and expressiveness
                synth.triggerAttackRelease("E5", "0.1");         // High, short initial blast
                synth.triggerAttackRelease("C6", "0.3", "+0.2"); // Louder, sustained blast 200ms later
            } catch (error) {
                console.error("Could not play sound.", error);
                statusMessage.textContent = "Timer done! (Sound error)";
            }
        };

        // Core timer function
        const tick = () => {
            currentTimeLeft--;
            updateUI();

            if (currentTimeLeft <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                isRunning = false;
                
                playAlarm();
                statusMessage.textContent = "REST TIME OVER! GET BACK TO WORK!";

                // Wait 1 second before resetting the display to emphasize the end
                setTimeout(resetTimer, 1000);
            } else if (currentTimeLeft <= 10) {
                // Flash the display for the last 10 seconds
                timerDisplay.classList.toggle('text-red-500');
                statusMessage.textContent = `Time remaining: ${currentTimeLeft}s`;
            } else {
                statusMessage.textContent = "Rest in progress...";
            }
        };
        
        // Resets the timer to the currently set time
        const resetTimer = () => {
            currentTimeLeft = currentSetTime;
            updateUI();
            statusMessage.textContent = "Ready for the next set.";
        }

        // --- Event Handlers ---

        // Main Start/Stop/Reset logic
        mainActionButton.addEventListener('click', async () => {
            // FIX: Ensure Tone.js AudioContext is running on the first user interaction
            if (Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                } catch (e) {
                    console.error("Failed to start audio context:", e);
                }
            }

            if (isRunning) {
                // Stop/Pause logic
                clearInterval(timerInterval);
                timerInterval = null;
                isRunning = false;
                statusMessage.textContent = `Paused at ${formatTime(currentTimeLeft)}.`;
            } else if (currentTimeLeft > 0) {
                // Start logic
                isRunning = true;
                timerInterval = setInterval(tick, 1000);
            } else {
                // Reset and Start (if timer was at 0)
                resetTimer();
                isRunning = true;
                timerInterval = setInterval(tick, 1000);
            }
            updateUI();
        });

        // Time adjustment controls
        adjustUpButton.addEventListener('click', () => {
            if (isRunning) return;
            currentSetTime += INCREMENT;
            resetTimer();
        });

        adjustDownButton.addEventListener('click', () => {
            if (isRunning || currentSetTime <= INCREMENT) return;
            currentSetTime -= INCREMENT;
            resetTimer();
        });

        // Initialize the UI on load
        window.onload = updateUI;
    </script>
</body>
</html>